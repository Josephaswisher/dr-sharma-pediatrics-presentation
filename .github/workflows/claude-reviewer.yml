name: Claude Code Reviewer

on:
  pull_request:
    types: [opened, synchronize]
  issue_comment:
    types: [created]

jobs:
  claude-review:
    if: |
      (github.event_name == 'pull_request') ||
      (github.event.comment && contains(github.event.comment.body, '/claude-review'))
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get PR Diff
        id: diff
        run: |
          git fetch origin ${{ github.base_ref }}
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt
          echo "diff_size=$(wc -l < pr_diff.txt)" >> $GITHUB_OUTPUT
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install Dependencies
        run: |
          npm install @anthropic-ai/sdk
      
      - name: Claude Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          cat > claude_review.js << 'JSEOF'
          const Anthropic = require('@anthropic-ai/sdk');
          const fs = require('fs');
          
          const client = new Anthropic({
            apiKey: process.env.ANTHROPIC_API_KEY
          });
          
          async function reviewCode() {
            const diff = fs.readFileSync('pr_diff.txt', 'utf8');
            
            const message = await client.messages.create({
              model: "claude-3-5-sonnet-20241022",
              max_tokens: 6000,
              messages: [{
                role: "user",
                content: `You are an expert code reviewer. Review this pull request diff and provide:
          
          1. **Summary**: Brief overview of changes
          2. **Architecture**: Design and architectural considerations
          3. **Security**: Potential security vulnerabilities
          4. **Performance**: Performance implications
          5. **Best Practices**: Code quality and style issues
          6. **Suggestions**: Specific improvement recommendations
          
          Be constructive and specific. Use markdown formatting.
          
          Diff:
          \`\`\`diff
          ${diff}
          \`\`\`
          `
              }]
            });
            
            const review = message.content[0].text;
            fs.writeFileSync('review.md', review);
          }
          
          reviewCode().catch(console.error);
          JSEOF
          
          node claude_review.js
      
      - name: Post Review
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('review.md', 'utf8');
            
            const prNumber = context.payload.pull_request?.number || 
                            context.payload.issue?.number;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `## ðŸ¤– Claude Code Review\n\n${review}\n\n---\n*Powered by Claude 3.5 Sonnet*`
            });
