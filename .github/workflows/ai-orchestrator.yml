name: AI Orchestrator (Claude + Codex)

on:
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      task:
        description: 'AI Task'
        required: true
        type: choice
        options:
          - full-analysis
          - security-audit
          - performance-review
          - refactor-suggestions

jobs:
  ai-orchestrator:
    if: contains(github.event.comment.body, '/ai-analyze') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python & Node
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install AI Dependencies
        run: |
          pip install openai anthropic
          npm install @anthropic-ai/sdk openai
      
      - name: Run AI Analysis
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          cat > ai_orchestrator.py << 'PYEOF'
          import os
          import json
          from anthropic import Anthropic
          from openai import OpenAI
          
          claude = Anthropic(api_key=os.environ['ANTHROPIC_API_KEY'])
          codex = OpenAI(api_key=os.environ['OPENAI_API_KEY'])
          
          # Scan codebase
          code_files = []
          for root, dirs, files in os.walk('.'):
              # Skip common directories
              dirs[:] = [d for d in dirs if d not in ['.git', 'node_modules', '__pycache__', '.venv']]
              for file in files:
                  if file.endswith(('.py', '.js', '.ts', '.go', '.rs', '.java', '.c', '.cpp')):
                      filepath = os.path.join(root, file)
                      try:
                          with open(filepath, 'r') as f:
                              code_files.append({'path': filepath, 'content': f.read()})
                      except:
                          pass
          
          # Claude 4.5 Sonnet: High-level architecture analysis (Latest Model)
          claude_analysis = claude.messages.create(
              model="claude-3-5-sonnet-20241022",
              max_tokens=16384,
              messages=[{
                  "role": "user",
                  "content": f"""Analyze this codebase architecture:
          
          Files: {json.dumps([f['path'] for f in code_files[:20]], indent=2)}
          
          Provide:
          1. Architecture overview
          2. Design patterns used
          3. Potential architectural issues
          4. Scalability concerns
          5. Recommendations
          """
              }]
          )
          
          # GPT-4.1 Mini Thinking: Security and code quality analysis (Latest Model)
          codex_analysis = codex.chat.completions.create(
              model="gpt-4.1-mini",
              messages=[{
                  "role": "system",
                  "content": "You are a security and code quality expert."
              }, {
                  "role": "user",
                  "content": f"""Analyze these code files for security and quality:
          
          {json.dumps([{'path': f['path'], 'preview': f['content'][:500]} for f in code_files[:10]], indent=2)}
          
          Focus on:
          1. Security vulnerabilities
          2. Code smells
          3. Performance bottlenecks
          4. Error handling
          5. Testing gaps
          """
              }]
          )
          
          # Generate combined report
          report = f"""# AI Codebase Analysis Report
          
          ## ðŸ—ï¸ Architecture Analysis (Claude)
          
          {claude_analysis.content[0].text}
          
          ## ðŸ”’ Security & Quality Analysis (Codex)
          
          {codex_analysis.choices[0].message.content}
          
          ## ðŸ“Š Statistics
          
          - Total files analyzed: {len(code_files)}
          - Languages detected: Python, JavaScript, TypeScript
          
          ---
          *Generated by AI Orchestrator (Claude 3.5 + GPT-4)*
          """
          
          with open('ai_report.md', 'w') as f:
              f.write(report)
          PYEOF
          
          python ai_orchestrator.py
      
      - name: Upload Report
        uses: actions/upload-artifact@v4
        with:
          name: ai-analysis-report
          path: ai_report.md
      
      - name: Post Report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('ai_report.md', 'utf8');
            
            if (context.payload.issue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: report
              });
            }
