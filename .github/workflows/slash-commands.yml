name: Slash Commands Router

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  route-command:
    runs-on: ubuntu-latest
    
    steps:
      - name: Parse Command
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            
            const commands = {
              '/claude-fix': 'claude_fix',
              '/claude-review': 'claude_review',
              '/claude-refactor': 'claude_refactor',
              '/codex-validate': 'codex_validate',
              '/codex-optimize': 'codex_optimize',
              '/codex-security': 'codex_security',
              '/ai-analyze': 'ai_analyze',
              '/ai-test': 'ai_test'
            };
            
            let detectedCommand = null;
            for (const [cmd, value] of Object.entries(commands)) {
              if (comment.includes(cmd)) {
                detectedCommand = value;
                break;
              }
            }
            
            core.setOutput('command', detectedCommand || 'none');
            core.setOutput('comment_body', comment);
      
      - name: Acknowledge Command
        if: steps.parse.outputs.command != 'none'
        uses: actions/github-script@v7
        with:
          script: |
            const command = '${{ steps.parse.outputs.command }}';
            const emoji = {
              'claude_fix': 'ğŸ”§',
              'claude_review': 'ğŸ‘€',
              'claude_refactor': 'â™»ï¸',
              'codex_validate': 'âœ…',
              'codex_optimize': 'âš¡',
              'codex_security': 'ğŸ”’',
              'ai_analyze': 'ğŸ”',
              'ai_test': 'ğŸ§ª'
            };
            
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: '+1'
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `${emoji[command] || 'ğŸ¤–'} Processing command \`${command}\`...`
            });
